<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - إدارة العضوية</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-title {
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 16px;
        }

        .section {
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .search-bar {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .action-btn.view {
            background: #17a2b8;
            color: white;
        }

        .action-btn.edit {
            background: #28a745;
            color: white;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state img {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .add-member-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .add-member-btn:hover {
            background: #218838;
        }

        .refresh-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #138496;
        }

        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                justify-content: center;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">لوحة التحكم - إدارة العضوية</h1>
            <div class="user-info">
                <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">🔄 تحديث البيانات</button>
                <div class="user-avatar">A</div>
                <span>مرحباً، admin</span>
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalMembers">0</div>
                <div class="stat-label">إجمالي الأعضاء</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingApplications">0</div>
                <div class="stat-label">في انتظار المراجعة</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="approvedApplications">0</div>
                <div class="stat-label">تم الموافقة عليها</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rejectedApplications">0</div>
                <div class="stat-label">تم الرفض</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="renewalRequests">0</div>
                <div class="stat-label">طلبات التجديد</div>
            </div>
        </div>

        <!-- Renewal Requests Section -->
        <div class="section">
            <div class="section-header">
                📋 إدارة طلبات التجديد
            </div>
            <div class="section-content">
                <div class="tabs">
                    <div class="tab active" onclick="filterRenewalRequests('all')">الكل</div>
                    <div class="tab" onclick="filterRenewalRequests('pending')">في الانتظار</div>
                    <div class="tab" onclick="filterRenewalRequests('approved')">موافق عليها</div>
                    <div class="tab" onclick="filterRenewalRequests('rejected')">مرفوضة</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>اسم العضو</th>
                                <th>رقم العضوية</th>
                                <th>تاريخ الطلب</th>
                                <th>تاريخ الانتهاء الحالي</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="renewalRequestsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="renewalRequestsEmptyState" class="empty-state" style="display: none;">
                    📋<br>
                    لا توجد طلبات تجديد<br>
                    ستظهر الطلبات هنا عند توفرها
                </div>
            </div>
        </div>

        <!-- Members Management Section -->
        <div class="section">
            <div class="section-header">
                👥 إدارة الأعضاء
            </div>
            <div class="section-content">
                <div class="tabs">
                    <div class="tab" onclick="exportData()">📤 تصدير البيانات</div>
                    <button class="add-member-btn" onclick="window.location.href='add-old-member.html'">➕ إضافة عضو قديم</button>
                    <button class="add-member-btn" onclick="window.location.href='qr-scanner.html'" style="background: #f59e0b;">📱 مفتاح استلام باركود</button>
                    <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">🔄 تحديث البيانات</button>
                </div>
                
                <input type="text" class="search-bar" placeholder="البحث في الأعضاء..." onkeyup="searchMembers(this.value)">
                
                <div class="tabs">
                    <div class="tab active" onclick="filterMembers('all')">الكل</div>
                    <div class="tab" onclick="filterMembers('active')">نشط</div>
                    <div class="tab" onclick="filterMembers('affiliated')">عضو منتسب</div>
                    <div class="tab" onclick="filterMembers('non-affiliated')">عضو غير منتسب</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم العضوية</th>
                                <th>الاسم</th>
                                <th>البريد الالكتروني</th>
                                <th>الهاتف</th>
                                <th>نوع العضوية</th>
                                <th>تاريخ التقديم</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="membersEmptyState" class="empty-state" style="display: none;">
                    👥<br>
                    لا توجد أعضاء<br>
                    ستظهر الأعضاء هنا عند توفرهم
                </div>
            </div>
        </div>

        <!-- Applications Section -->
        <div class="section">
            <div class="section-header">
                📋 طلبات العضوية
            </div>
            <div class="section-content">
                <div class="tabs">
                    <div class="tab active" onclick="filterApplications('all')">الكل</div>
                    <div class="tab" onclick="filterApplications('pending')">في الانتظار</div>
                    <div class="tab" onclick="filterApplications('approved')">موافق عليها</div>
                    <div class="tab" onclick="filterApplications('rejected')">مرفوضة</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>البريد الالكتروني</th>
                                <th>الهاتف</th>
                                <th>نوع العضوية</th>
                                <th>تاريخ التقديم</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="applicationsEmptyState" class="empty-state" style="display: none;">
                    📋<br>
                    لا توجد طلبات<br>
                    ستظهر الطلبات هنا عند توفرها
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjGGNvJKvBXQBYWV5R7Ck8yF2QvJKvBXQ",
            authDomain: "kaml-membership-system.firebaseapp.com",
            projectId: "kaml-membership-system",
            storageBucket: "kaml-membership-system.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789012345"
        };

        // Initialize Firebase
        let db;
        let isFirebaseConnected = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseConnected = true;
            console.log('✅ Firebase connected successfully');
        } catch (error) {
            console.error('❌ Firebase connection failed:', error);
            isFirebaseConnected = false;
        }

        // Firebase Data Manager
        class FirebaseDataManager {
            constructor() {
                this.isOnline = isFirebaseConnected;
                console.log('Firebase Manager initialized. Online:', this.isOnline);
            }

            async saveData(collection, data) {
                if (!this.isOnline) {
                    console.log('Firebase offline - saving to localStorage only');
                    this.saveToLocalStorage(collection, data);
                    return;
                }

                try {
                    const docRef = await db.collection(collection).add(data);
                    console.log('✅ Data saved to Firebase:', docRef.id);
                    
                    // Also save to localStorage as backup
                    this.saveToLocalStorage(collection, { ...data, id: docRef.id });
                    return docRef.id;
                } catch (error) {
                    console.error('❌ Firebase save error:', error);
                    // Fallback to localStorage
                    this.saveToLocalStorage(collection, data);
                }
            }

            async loadData(collection) {
                console.log(`🔄 Loading data from collection: ${collection}`);
                
                if (!this.isOnline) {
                    console.log('Firebase offline - loading from localStorage');
                    return this.loadFromLocalStorage(collection);
                }

                try {
                    // Try multiple collection names
                    const possibleNames = [
                        collection,
                        'applications',
                        'membershipApplications',
                        'membership_requests',
                        'members',
                        'renewalRequests'
                    ];

                    let data = [];
                    
                    for (const name of possibleNames) {
                        try {
                            console.log(`🔍 Trying collection: ${name}`);
                            const snapshot = await db.collection(name).get();
                            
                            if (!snapshot.empty) {
                                console.log(`✅ Found data in collection: ${name} (${snapshot.size} documents)`);
                                snapshot.forEach(doc => {
                                    data.push({ id: doc.id, ...doc.data() });
                                });
                                
                                // Update localStorage with Firebase data
                                localStorage.setItem(collection, JSON.stringify(data));
                                console.log(`💾 Updated localStorage for ${collection} with ${data.length} items`);
                                return data;
                            }
                        } catch (collectionError) {
                            console.log(`⚠️ Collection ${name} not accessible:`, collectionError.message);
                        }
                    }
                    
                    console.log('⚠️ No data found in any collection, using localStorage');
                    return this.loadFromLocalStorage(collection);
                    
                } catch (error) {
                    console.error('❌ Firebase load error:', error);
                    return this.loadFromLocalStorage(collection);
                }
            }

            saveToLocalStorage(collection, data) {
                try {
                    const existingData = JSON.parse(localStorage.getItem(collection) || '[]');
                    const newData = Array.isArray(data) ? data : [data];
                    const updatedData = [...existingData, ...newData];
                    localStorage.setItem(collection, JSON.stringify(updatedData));
                    console.log(`💾 Saved to localStorage: ${collection}`);
                } catch (error) {
                    console.error('❌ localStorage save error:', error);
                }
            }

            loadFromLocalStorage(collection) {
                try {
                    const data = JSON.parse(localStorage.getItem(collection) || '[]');
                    console.log(`💾 Loaded from localStorage: ${collection} (${data.length} items)`);
                    return data;
                } catch (error) {
                    console.error('❌ localStorage load error:', error);
                    return [];
                }
            }
        }

        // Initialize Firebase Data Manager
        const firebaseManager = new FirebaseDataManager();

        // Logout function
        function logout() {
            console.log('🚪 Logging out...');
            
            // Clear session data
            sessionStorage.clear();
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('currentUser');
            
            // Show confirmation
            alert('تم تسجيل الخروج بنجاح');
            
            // Redirect to login page
            window.location.href = 'admin-login.html';
        }

        // Get status text in Arabic
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'في الانتظار';
                case 'approved': return 'موافق عليه';
                case 'rejected': return 'مرفوض';
                case 'active': return 'نشط';
                case 'inactive': return 'غير نشط';
                default: return 'غير محدد';
            }
        }

        // Load statistics
        async function loadStats() {
            console.log('📊 Loading statistics...');
            
            try {
                const applications = await firebaseManager.loadData('membershipApplications');
                const members = await firebaseManager.loadData('members');
                const renewals = await firebaseManager.loadData('renewalRequests');
                
                const pending = applications.filter(app => app.status === 'pending').length;
                const approved = applications.filter(app => app.status === 'approved').length;
                const rejected = applications.filter(app => app.status === 'rejected').length;
                
                document.getElementById('totalMembers').textContent = members.length;
                document.getElementById('pendingApplications').textContent = pending;
                document.getElementById('approvedApplications').textContent = approved;
                document.getElementById('rejectedApplications').textContent = rejected;
                document.getElementById('renewalRequests').textContent = renewals.length;
                
                console.log('📊 Statistics updated:', { 
                    total: members.length, 
                    pending, 
                    approved, 
                    rejected, 
                    renewals: renewals.length 
                });
                
            } catch (error) {
                console.error('❌ Error loading statistics:', error);
            }
        }

        // Load applications
        async function loadApplications() {
            console.log('📋 Loading applications...');
            
            try {
                const applications = await firebaseManager.loadData('membershipApplications');
                console.log('📋 Applications loaded:', applications.length);
                
                const tbody = document.getElementById('applicationsTableBody');
                const emptyState = document.getElementById('applicationsEmptyState');
                
                if (applications.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    console.log('📋 No applications found - showing empty state');
                    return;
                }
                
                emptyState.style.display = 'none';
                tbody.innerHTML = applications.map(app => {
                    const firstName = app.firstNameAr || app.first_name_ar || app.firstName || 'غير محدد';
                    const middleName = app.middleNameAr || app.middle_name_ar || app.middleName || '';
                    const lastName = app.lastNameAr || app.last_name_ar || app.lastName || 'غير محدد';
                    const email = app.email || 'غير محدد';
                    const phone = app.phone || 'غير محدد';
                    const membershipType = app.membershipType || app.membership_type || 'غير محدد';
                    const submissionDate = app.submissionDate || app.submission_date || app.createdAt || new Date().toISOString();
                    const status = app.status || 'pending';
                    const appId = app.id || app.applicationId || Date.now().toString();
                    
                    console.log('📋 Processing application:', { firstName, lastName, email, status });
                    
                    return `
                        <tr>
                            <td>${firstName} ${middleName} ${lastName}</td>
                            <td>${email}</td>
                            <td>${phone}</td>
                            <td>${membershipType}</td>
                            <td>${new Date(submissionDate).toLocaleDateString('en-GB')}</td>
                            <td><span class="status-badge status-${status}">${getStatusText(status)}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewApplicationDetails('${appId}')">عرض</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log('✅ Applications table updated');
                
            } catch (error) {
                console.error('❌ Error loading applications:', error);
                
                // Show error message to user
                const tbody = document.getElementById('applicationsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #dc3545; padding: 20px;">
                            ❌ خطأ في تحميل البيانات: ${error.message}<br>
                            <button onclick="refreshData()" style="margin-top: 10px; padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 إعادة المحاولة
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        // Load members
        async function loadMembers() {
            console.log('👥 Loading members...');
            
            try {
                const members = await firebaseManager.loadData('members');
                console.log('👥 Members loaded:', members.length);
                
                const tbody = document.getElementById('membersTableBody');
                const emptyState = document.getElementById('membersEmptyState');
                
                if (members.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                tbody.innerHTML = members.map(member => {
                    const membershipNumber = member.membershipNumber || member.membership_number || 'غير محدد';
                    const name = member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim() || 'غير محدد';
                    const email = member.email || 'غير محدد';
                    const phone = member.phone || 'غير محدد';
                    const membershipType = member.membershipType || member.membership_type || 'غير محدد';
                    const joinDate = member.joinDate || member.join_date || member.createdAt || new Date().toISOString();
                    const status = member.status || 'active';
                    const memberId = member.id || member.memberId || Date.now().toString();
                    
                    return `
                        <tr>
                            <td>${membershipNumber}</td>
                            <td>${name}</td>
                            <td>${email}</td>
                            <td>${phone}</td>
                            <td>${membershipType}</td>
                            <td>${new Date(joinDate).toLocaleDateString('en-GB')}</td>
                            <td><span class="status-badge status-${status}">${getStatusText(status)}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewMemberDetails('${memberId}')">عرض</button>
                                    <button class="action-btn edit" onclick="editMember('${memberId}')">تعديل</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log('✅ Members table updated');
                
            } catch (error) {
                console.error('❌ Error loading members:', error);
            }
        }

        // Load renewal requests
        async function loadRenewalRequests() {
            console.log('🔄 Loading renewal requests...');
            
            try {
                const renewals = await firebaseManager.loadData('renewalRequests');
                console.log('🔄 Renewal requests loaded:', renewals.length);
                
                const tbody = document.getElementById('renewalRequestsTableBody');
                const emptyState = document.getElementById('renewalRequestsEmptyState');
                
                if (renewals.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                tbody.innerHTML = renewals.map(renewal => {
                    const requestId = renewal.id || renewal.requestId || Date.now().toString();
                    const memberName = renewal.memberName || renewal.member_name || 'غير محدد';
                    const membershipNumber = renewal.membershipNumber || renewal.membership_number || 'غير محدد';
                    const requestDate = renewal.requestDate || renewal.request_date || new Date().toISOString();
                    const currentExpiry = renewal.currentExpiry || renewal.current_expiry || 'غير محدد';
                    const status = renewal.status || 'pending';
                    
                    return `
                        <tr>
                            <td>${requestId}</td>
                            <td>${memberName}</td>
                            <td>${membershipNumber}</td>
                            <td>${new Date(requestDate).toLocaleDateString('en-GB')}</td>
                            <td>${new Date(currentExpiry).toLocaleDateString('en-GB')}</td>
                            <td><span class="status-badge status-${status}">${getStatusText(status)}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewRenewalDetails('${requestId}')">عرض</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log('✅ Renewal requests table updated');
                
            } catch (error) {
                console.error('❌ Error loading renewal requests:', error);
            }
        }

        // Refresh data function
        async function refreshData() {
            console.log('🔄 Manual refresh triggered...');
            
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '⏳ جاري التحديث...';
            refreshBtn.disabled = true;
            
            try {
                // Force reload from Firebase
                if (firebaseManager.isOnline) {
                    console.log('🔄 Refreshing from Firebase...');
                    await firebaseManager.loadData('membershipApplications');
                    await firebaseManager.loadData('members');
                    await firebaseManager.loadData('renewalRequests');
                }
                
                // Reload all sections
                await loadStats();
                await loadApplications();
                await loadMembers();
                await loadRenewalRequests();
                
                console.log('✅ Refresh completed successfully');
                alert('تم تحديث البيانات بنجاح!');
                
            } catch (error) {
                console.error('❌ Refresh error:', error);
                alert('حدث خطأ أثناء التحديث: ' + error.message);
            }
            
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        }

        // View application details
        function viewApplicationDetails(applicationId) {
            console.log('👁️ Viewing application:', applicationId);
            window.open(`review-application.html?id=${applicationId}`, '_blank');
        }

        // View member details
        function viewMemberDetails(memberId) {
            console.log('👁️ Viewing member:', memberId);
            window.open(`member-profile.html?id=${memberId}`, '_blank');
        }

        // Edit member
        function editMember(memberId) {
            console.log('✏️ Editing member:', memberId);
            window.open(`edit-member.html?id=${memberId}`, '_blank');
        }

        // View renewal details
        function viewRenewalDetails(renewalId) {
            console.log('👁️ Viewing renewal:', renewalId);
            // Implement renewal details view
            alert('عرض تفاصيل طلب التجديد: ' + renewalId);
        }

        // Filter functions
        function filterApplications(filter) {
            console.log('🔍 Filtering applications:', filter);
            // Update active tab
            document.querySelectorAll('.section:last-child .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Implement filtering logic
            loadApplications();
        }

        function filterMembers(filter) {
            console.log('🔍 Filtering members:', filter);
            // Update active tab
            document.querySelectorAll('.section:nth-child(4) .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Implement filtering logic
            loadMembers();
        }

        function filterRenewalRequests(filter) {
            console.log('🔍 Filtering renewal requests:', filter);
            // Update active tab
            document.querySelectorAll('.section:nth-child(3) .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Implement filtering logic
            loadRenewalRequests();
        }

        // Search function
        function searchMembers(query) {
            console.log('🔍 Searching members:', query);
            // Implement search logic
        }

        // Export data function
        async function exportData() {
            console.log('📤 Starting data export...');
            
            try {
                // Show loading
                const originalText = event.target.textContent;
                event.target.textContent = '⏳ جاري التصدير...';
                event.target.disabled = true;
                
                // Load all data
                const applications = await firebaseManager.loadData('membershipApplications');
                const members = await firebaseManager.loadData('members');
                const renewals = await firebaseManager.loadData('renewalRequests');
                
                // Create export menu
                const exportMenu = document.createElement('div');
                exportMenu.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 30px;
                    border-radius: 12px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    z-index: 10000;
                    min-width: 400px;
                    text-align: center;
                `;
                
                exportMenu.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #1e293b;">📤 تصدير البيانات</h3>
                    <p style="margin-bottom: 20px; color: #6b7280;">اختر نوع البيانات المراد تصديرها:</p>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="exportToExcel('applications', ${JSON.stringify(applications).replace(/"/g, '&quot;')}, 'طلبات_العضوية')" 
                                style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            📊 تصدير طلبات العضوية (Excel)
                        </button>
                        <button onclick="exportToExcel('members', ${JSON.stringify(members).replace(/"/g, '&quot;')}, 'الأعضاء')" 
                                style="padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            👥 تصدير بيانات الأعضاء (Excel)
                        </button>
                        <button onclick="exportToExcel('renewals', ${JSON.stringify(renewals).replace(/"/g, '&quot;')}, 'طلبات_التجديد')" 
                                style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            🔄 تصدير طلبات التجديد (Excel)
                        </button>
                        <button onclick="exportAllToPDF()" 
                                style="padding: 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            📄 تصدير تقرير شامل (PDF)
                        </button>
                        <button onclick="closeExportMenu()" 
                                style="padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                            ❌ إلغاء
                        </button>
                    </div>
                `;
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                `;
                overlay.id = 'exportOverlay';
                
                document.body.appendChild(overlay);
                document.body.appendChild(exportMenu);
                exportMenu.id = 'exportMenu';
                
                // Restore button
                event.target.textContent = originalText;
                event.target.disabled = false;
                
            } catch (error) {
                console.error('❌ Export error:', error);
                alert('حدث خطأ أثناء التصدير: ' + error.message);
                
                // Restore button
                event.target.textContent = originalText;
                event.target.disabled = false;
            }
        }

        // Export to Excel function
        function exportToExcel(type, data, filename) {
            try {
                const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                
                if (!parsedData || parsedData.length === 0) {
                    alert('لا توجد بيانات للتصدير');
                    return;
                }
                
                // Create CSV content
                let csvContent = '';
                let headers = [];
                
                if (type === 'applications') {
                    headers = ['الاسم بالعربية', 'الاسم بالإنجليزية', 'الرقم المدني', 'البريد الإلكتروني', 'الهاتف', 'التخصص', 'جهة العمل', 'المسمى الوظيفي', 'تاريخ التقديم', 'الحالة'];
                    csvContent = headers.join(',') + '\n';
                    
                    parsedData.forEach(app => {
                        const row = [
                            `"${(app.first_name_ar || '') + ' ' + (app.middle_name_ar || '') + ' ' + (app.last_name_ar || '')}"`,
                            `"${(app.first_name_en || '') + ' ' + (app.middle_name_en || '') + ' ' + (app.last_name_en || '')}"`,
                            `"${app.civil_id || app.civilId || ''}"`,
                            `"${app.email || ''}"`,
                            `"${app.phone || ''}"`,
                            `"${app.specialization || ''}"`,
                            `"${app.workplace || ''}"`,
                            `"${app.job_title || app.jobTitle || ''}"`,
                            `"${app.submission_date ? new Date(app.submission_date).toLocaleDateString('ar-SA') : ''}"`,
                            `"${getStatusText(app.status || 'pending')}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                } else if (type === 'members') {
                    headers = ['رقم العضوية', 'الاسم بالعربية', 'الاسم بالإنجليزية', 'الرقم المدني', 'البريد الإلكتروني', 'الهاتف', 'نوع العضوية', 'تاريخ الانضمام', 'تاريخ انتهاء العضوية', 'الحالة'];
                    csvContent = headers.join(',') + '\n';
                    
                    parsedData.forEach(member => {
                        const row = [
                            `"${member.membershipNumber || ''}"`,
                            `"${(member.firstNameAr || '') + ' ' + (member.middleNameAr || '') + ' ' + (member.lastNameAr || '')}"`,
                            `"${(member.firstNameEn || '') + ' ' + (member.middleNameEn || '') + ' ' + (member.lastNameEn || '')}"`,
                            `"${member.civilId || ''}"`,
                            `"${member.email || ''}"`,
                            `"${member.phone || ''}"`,
                            `"${member.membershipType || ''}"`,
                            `"${member.joinDate ? new Date(member.joinDate).toLocaleDateString('ar-SA') : ''}"`,
                            `"${member.expiryDate ? new Date(member.expiryDate).toLocaleDateString('ar-SA') : ''}"`,
                            `"${member.status || 'active'}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                }
                
                // Download CSV file
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`تم تصدير ${parsedData.length} سجل بنجاح!`);
                closeExportMenu();
                
            } catch (error) {
                console.error('❌ Excel export error:', error);
                alert('حدث خطأ أثناء التصدير: ' + error.message);
            }
        }

        // Export all to PDF function
        async function exportAllToPDF() {
            try {
                // Load all data
                const applications = await firebaseManager.loadData('membershipApplications');
                const members = await firebaseManager.loadData('members');
                const renewals = await firebaseManager.loadData('renewalRequests');
                
                // Create PDF content
                let pdfContent = `
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>تقرير شامل - الجمعية الكويتية للمختبرات الطبية</title>
                        <style>
                            body { font-family: Arial, sans-serif; direction: rtl; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 30px; }
                            .section h2 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                            th { background-color: #f5f5f5; }
                            .stats { display: flex; justify-content: space-around; margin-bottom: 20px; }
                            .stat-box { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>تقرير شامل</h1>
                            <h2>الجمعية الكويتية للمختبرات الطبية</h2>
                            <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>
                        
                        <div class="stats">
                            <div class="stat-box">
                                <h3>${applications.length}</h3>
                                <p>طلبات العضوية</p>
                            </div>
                            <div class="stat-box">
                                <h3>${members.length}</h3>
                                <p>الأعضاء المسجلين</p>
                            </div>
                            <div class="stat-box">
                                <h3>${renewals.length}</h3>
                                <p>طلبات التجديد</p>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>ملخص طلبات العضوية</h2>
                            <table>
                                <tr><th>الاسم</th><th>البريد الإلكتروني</th><th>الهاتف</th><th>الحالة</th></tr>
                `;
                
                applications.slice(0, 20).forEach(app => {
                    pdfContent += `
                        <tr>
                            <td>${(app.first_name_ar || '') + ' ' + (app.middle_name_ar || '') + ' ' + (app.last_name_ar || '')}</td>
                            <td>${app.email || ''}</td>
                            <td>${app.phone || ''}</td>
                            <td>${getStatusText(app.status || 'pending')}</td>
                        </tr>
                    `;
                });
                
                pdfContent += `
                            </table>
                        </div>
                        
                        <div class="section">
                            <h2>ملخص الأعضاء المسجلين</h2>
                            <table>
                                <tr><th>رقم العضوية</th><th>الاسم</th><th>نوع العضوية</th><th>الحالة</th></tr>
                `;
                
                members.slice(0, 20).forEach(member => {
                    pdfContent += `
                        <tr>
                            <td>${member.membershipNumber || ''}</td>
                            <td>${(member.firstNameAr || '') + ' ' + (member.middleNameAr || '') + ' ' + (member.lastNameAr || '')}</td>
                            <td>${member.membershipType || ''}</td>
                            <td>${member.status || 'active'}</td>
                        </tr>
                    `;
                });
                
                pdfContent += `
                            </table>
                        </div>
                    </body>
                    </html>
                `;
                
                // Create and download PDF
                const blob = new Blob([pdfContent], { type: 'text/html' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `تقرير_شامل_${new Date().toISOString().split('T')[0]}.html`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('تم إنشاء التقرير الشامل بنجاح!');
                closeExportMenu();
                
            } catch (error) {
                console.error('❌ PDF export error:', error);
                alert('حدث خطأ أثناء إنشاء التقرير: ' + error.message);
            }
        }

        // Close export menu
        function closeExportMenu() {
            const overlay = document.getElementById('exportOverlay');
            const menu = document.getElementById('exportMenu');
            if (overlay) document.body.removeChild(overlay);
            if (menu) document.body.removeChild(menu);
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Dashboard loading started...');
            
            // Check if user is logged in
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn') || localStorage.getItem('adminLoggedIn');
            if (!isLoggedIn) {
                console.log('❌ User not logged in, redirecting...');
                window.location.href = 'admin-login.html';
                return;
            }
            
            try {
                console.log('📊 Loading dashboard data...');
                
                // Load all data
                await loadStats();
                await loadApplications();
                await loadMembers();
                await loadRenewalRequests();
                
                console.log('✅ Dashboard loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading dashboard:', error);
                alert('حدث خطأ في تحميل لوحة التحكم: ' + error.message);
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
        });

        console.log('📋 Dashboard script loaded successfully');
    </script>
</body>
</html>

