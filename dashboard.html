<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - إدارة العضوية</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            direction: rtl;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .main-content {
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* الإحصائيات */
        .stats-container {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-card.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-icon.total { background: #3b82f6; }
        .stat-icon.pending { background: #f59e0b; }
        .stat-icon.rejected { background: #ef4444; }
        .stat-icon.renewal { background: #10b981; }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        /* البحث والفلاتر */
        .search-section {
            padding: 25px 30px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 15px;
            align-items: end;
        }

        .search-group {
            display: flex;
            flex-direction: column;
        }

        .search-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .search-input {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .search-select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* الجدول */
        .table-section {
            padding: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8fafc;
            padding: 15px 12px;
            text-align: right;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .table td {
            padding: 15px 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #4b5563;
            font-size: 14px;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-renewal {
            background: #dbeafe;
            color: #1e40af;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn-view {
            background: #3b82f6;
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
        }

        .btn-approve {
            background: #10b981;
            color: white;
        }

        .btn-approve:hover {
            background: #059669;
        }

        .btn-reject {
            background: #ef4444;
            color: white;
        }

        .btn-reject:hover {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-info {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            color: #374151;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .search-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .table-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .table-actions {
                justify-content: center;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-actions {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 10px;
            }

            .table-container {
                overflow-x: auto;
            }

            .table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎛️ لوحة التحكم - إدارة العضوية</h1>
            <div class="header-actions">
                <a href="add-old-member.html" class="btn btn-primary">
                    👥 إضافة عضو قديم
                </a>
                <a href="qr-scanner.html" class="btn btn-secondary">
                    📱 مسح الباركود
                </a>
                <button onclick="exportData()" class="btn btn-secondary">
                    📊 تصدير البيانات
                </button>
                <a href="index.html" class="btn btn-danger">
                    🚪 تسجيل الخروج
                </a>
            </div>
        </div>

        <div class="main-content">
            <!-- الإحصائيات -->
            <div class="stats-container">
                <div class="stats-grid">
                    <div class="stat-card" id="totalCard" onclick="filterData('all')">
                        <div class="stat-header">
                            <div class="stat-icon total">👥</div>
                            <div>
                                <div class="stat-number" id="totalCount">0</div>
                                <div class="stat-label">إجمالي الأعضاء</div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card" id="pendingCard" onclick="filterData('pending')">
                        <div class="stat-header">
                            <div class="stat-icon pending">⏳</div>
                            <div>
                                <div class="stat-number" id="pendingCount">0</div>
                                <div class="stat-label">في انتظار المراجعة</div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card" id="rejectedCard" onclick="filterData('rejected')">
                        <div class="stat-header">
                            <div class="stat-icon rejected">❌</div>
                            <div>
                                <div class="stat-number" id="rejectedCount">0</div>
                                <div class="stat-label">تم الرفض</div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card" id="renewalCard" onclick="filterData('renewal')">
                        <div class="stat-header">
                            <div class="stat-icon renewal">🔄</div>
                            <div>
                                <div class="stat-number" id="renewalCount">0</div>
                                <div class="stat-label">طلبات التجديد</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- البحث والفلاتر -->
            <div class="search-section">
                <div class="search-grid">
                    <div class="search-group">
                        <label for="searchInput">البحث</label>
                        <input type="text" id="searchInput" class="search-input" placeholder="ابحث بالاسم، الرقم المدني، رقم العضوية...">
                    </div>
                    <div class="search-group">
                        <label for="searchType">نوع البحث</label>
                        <select id="searchType" class="search-select">
                            <option value="all">جميع الحقول</option>
                            <option value="name">الاسم</option>
                            <option value="civil_id">الرقم المدني</option>
                            <option value="membership_number">رقم العضوية</option>
                            <option value="email">البريد الإلكتروني</option>
                        </select>
                    </div>
                    <button onclick="searchData()" class="btn btn-primary">
                        🔍 بحث
                    </button>
                    <button onclick="clearSearch()" class="btn btn-secondary">
                        🗑️ مسح
                    </button>
                </div>
            </div>

            <!-- معلومات التشخيص -->
            <div id="debugInfo" class="debug-info" style="display: none;">
                <strong>معلومات التشخيص:</strong><br>
                <div id="debugText"></div>
            </div>

            <!-- الجدول -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title" id="tableTitle">
                        📋 جميع السجلات
                    </div>
                    <div class="table-actions">
                        <button onclick="toggleDebug()" class="btn btn-secondary btn-sm">
                            🔍 تشخيص
                        </button>
                        <button onclick="refreshData()" class="btn btn-secondary btn-sm">
                            🔄 تحديث
                        </button>
                        <button onclick="exportCurrentView()" class="btn btn-primary btn-sm">
                            📥 تصدير العرض الحالي
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <div id="loadingIndicator" class="loading">
                        <div class="spinner"></div>
                        <p>جاري تحميل البيانات...</p>
                    </div>

                    <table class="table" id="dataTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>الرقم المدني</th>
                                <th>الاسم</th>
                                <th>البريد الإلكتروني</th>
                                <th>الهاتف</th>
                                <th>رقم العضوية</th>
                                <th>نوع العضوية</th>
                                <th>تاريخ التقديم</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>

                    <div id="emptyState" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">📭</div>
                        <h3>لا توجد بيانات</h3>
                        <p>لم يتم العثور على أي سجلات تطابق المعايير المحددة</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBKvr6ZI_M_s_hk3Ch2ivWBuY5jSI9QxDo",
            authDomain: "kaml-membership-system.firebaseapp.com",
            projectId: "kaml-membership-system",
            storageBucket: "kaml-membership-system.firebasestorage.app",
            messagingSenderId: "1083658943439",
            appId: "1:1083658943439:web:f6a17e3bbdb6cd8feab0ba",
            measurementId: "G-ZZSZF3X7WC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // متغيرات عامة
        let allData = [];
        let filteredData = [];
        let currentFilter = 'all';
        let debugMode = false;

        // تحميل البيانات عند بدء الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من معامل التحديث في URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('refresh') === 'true') {
                console.log('تم طلب تحديث البيانات من صفحة المراجعة');
                // إزالة معامل التحديث من URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            loadData();
            
            // إضافة مستمع لتحديث البيانات عند التركيز على النافذة
            window.addEventListener('focus', function() {
                console.log('تم التركيز على النافذة - تحديث البيانات');
                loadData();
            });
        });

        // تحديث معلومات التشخيص
        function updateDebug(message) {
            console.log(message);
            if (debugMode) {
                const debugText = document.getElementById('debugText');
                if (debugText) {
                    debugText.innerHTML += message + '<br>';
                    debugText.scrollTop = debugText.scrollHeight;
                }
            }
        }

        // تبديل وضع التشخيص
        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            
            if (debugMode) {
                debugInfo.style.display = 'block';
                debugText.innerHTML = 'وضع التشخيص مفعل...<br>';
                updateDebug(`📊 إجمالي البيانات: ${allData.length}`);
                updateDebug(`🔍 الفلتر الحالي: ${currentFilter}`);
                updateDebug(`📋 البيانات المفلترة: ${filteredData.length}`);
                
                // عرض عينة من البيانات
                if (allData.length > 0) {
                    updateDebug(`📄 عينة من البيانات:`);
                    allData.slice(0, 3).forEach((item, index) => {
                        updateDebug(`${index + 1}. ID: ${item.id}, Status: ${item.status || 'undefined'}, Name: ${item.first_name_ar || 'undefined'}`);
                    });
                }
            } else {
                debugInfo.style.display = 'none';
            }
        }

        // تحميل البيانات من Firebase والتخزين المحلي
        async function loadData() {
            try {
                showLoading(true);
                updateDebug('🔄 بدء تحميل البيانات...');
                
                let firebaseData = [];
                
                // محاولة تحميل من مجموعات مختلفة في Firebase
                const possibleCollections = [
                    'membershipApplications',
                    'members',
                    'applications',
                    'registrations'
                ];

                for (const collectionName of possibleCollections) {
                    try {
                        updateDebug(`🔍 البحث في مجموعة: ${collectionName}`);
                        const snapshot = await db.collection(collectionName).get();
                        
                        if (!snapshot.empty) {
                            updateDebug(`✅ تم العثور على ${snapshot.size} سجل في ${collectionName}`);
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                
                                // تنظيف وإصلاح البيانات الناقصة
                                const cleanedData = {
                                    id: doc.id,
                                    first_name_ar: data.first_name_ar || data.firstName || '',
                                    middle_name_ar: data.middle_name_ar || data.middleName || '',
                                    last_name_ar: data.last_name_ar || data.lastName || '',
                                    civil_id: data.civil_id || data.civilId || '',
                                    email: data.email || '',
                                    phone: data.phone || '',
                                    status: data.status || (data.membership_number ? 'approved' : 'pending'),
                                    membership_number: data.membership_number || '',
                                    membership_type: data.membership_type || '',
                                    submissionDate: data.submissionDate || data.createdAt || new Date().toISOString(),
                                    source: collectionName,
                                    ...data // الاحتفاظ بباقي البيانات
                                };
                                
                                firebaseData.push(cleanedData);
                            });
                            
                            // لا نتوقف - نجمع من جميع المجموعات
                        } else {
                            updateDebug(`⚠️ مجموعة ${collectionName} فارغة`);
                        }
                    } catch (collectionError) {
                        updateDebug(`❌ خطأ في الوصول لمجموعة ${collectionName}: ${collectionError.message}`);
                    }
                }

                // تحميل من التخزين المحلي كنسخة احتياطية
                const localData = JSON.parse(localStorage.getItem('membershipApplications') || '[]');
                updateDebug(`💾 تم العثور على ${localData.length} سجل في التخزين المحلي`);
                
                // دمج البيانات (Firebase له الأولوية)
                const combinedData = [...firebaseData];
                localData.forEach(localItem => {
                    if (!combinedData.find(item => item.id === localItem.id)) {
                        // تنظيف البيانات المحلية أيضاً
                        const cleanedLocalData = {
                            id: localItem.id,
                            first_name_ar: localItem.first_name_ar || localItem.firstName || '',
                            middle_name_ar: localItem.middle_name_ar || localItem.middleName || '',
                            last_name_ar: localItem.last_name_ar || localItem.lastName || '',
                            civil_id: localItem.civil_id || localItem.civilId || '',
                            email: localItem.email || '',
                            phone: localItem.phone || '',
                            status: localItem.status || (localItem.membership_number ? 'approved' : 'pending'),
                            membership_number: localItem.membership_number || '',
                            membership_type: localItem.membership_type || '',
                            submissionDate: localItem.submissionDate || localItem.createdAt || new Date().toISOString(),
                            source: 'localStorage',
                            ...localItem // الاحتفاظ بباقي البيانات
                        };
                        
                        combinedData.push(cleanedLocalData);
                    }
                });

                updateDebug(`📊 إجمالي البيانات المحملة: ${combinedData.length}`);

                // تحليل الحالات مع عرض تفصيلي
                const statusCounts = {};
                combinedData.forEach(item => {
                    const status = item.status || 'undefined';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                updateDebug(`📈 إحصائيات الحالات: ${JSON.stringify(statusCounts)}`);
                
                // عرض عينة من البيانات للتشخيص
                if (combinedData.length > 0) {
                    updateDebug(`📄 عينة من البيانات المحملة:`);
                    combinedData.slice(0, 3).forEach((item, index) => {
                        const fullName = `${item.first_name_ar || ''} ${item.middle_name_ar || ''} ${item.last_name_ar || ''}`.trim();
                        updateDebug(`${index + 1}. ID: ${item.id}, Status: ${item.status}, Name: ${fullName || 'غير محدد'}, Source: ${item.source}`);
                    });
                }

                allData = combinedData;
                updateStatistics();
                filterData(currentFilter);

                // عرض رسالة إذا لم توجد بيانات
                if (combinedData.length === 0) {
                    updateDebug('⚠️ لم يتم العثور على أي بيانات');
                    showNoDataMessage();
                }
                
            } catch (error) {
                updateDebug(`❌ خطأ عام في تحميل البيانات: ${error.message}`);
                
                // الاعتماد على التخزين المحلي فقط
                const localData = JSON.parse(localStorage.getItem('membershipApplications') || '[]');
                updateDebug(`🔄 الاعتماد على التخزين المحلي: ${localData.length} سجل`);
                
                allData = localData.map(item => ({
                    ...item,
                    source: 'localStorage'
                }));
                updateStatistics();
                filterData(currentFilter);

                if (localData.length === 0) {
                    showNoDataMessage();
                }
            } finally {
                showLoading(false);
            }
        }

        // عرض رسالة عدم وجود بيانات
        function showNoDataMessage() {
            const emptyState = document.getElementById('emptyState');
            emptyState.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                    <h3 style="margin-bottom: 10px;">لا توجد بيانات</h3>
                    <p style="margin-bottom: 20px;">لم يتم العثور على أي طلبات عضوية في النظام</p>
                    <div style="font-size: 14px; color: #9ca3af;">
                        <p>للاختبار:</p>
                        <p>1. سجل عضو جديد من صفحة التسجيل</p>
                        <p>2. أو أضف عضو قديم من الأزرار أعلاه</p>
                    </div>
                </div>
            `;
            emptyState.style.display = 'block';
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            // حساب الإحصائيات بناءً على جميع الحالات الممكنة
            const total = allData.filter(item => {
                return item.status === 'approved' || 
                       item.status === 'معتمد' || 
                       item.membership_number;
            }).length;
            
            const pending = allData.filter(item => {
                return item.status === 'pending' || 
                       item.status === 'في الانتظار' || 
                       item.status === 'قيد المراجعة' ||
                       (!item.status && !item.membership_number);
            }).length;
            
            const rejected = allData.filter(item => {
                return item.status === 'rejected' || 
                       item.status === 'مرفوض';
            }).length;
            
            const renewal = allData.filter(item => {
                return item.status === 'renewal_requested' || 
                       item.status === 'طلب تجديد';
            }).length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('rejectedCount').textContent = rejected;
            document.getElementById('renewalCount').textContent = renewal;

            updateDebug(`📊 الإحصائيات المحدثة: معتمد=${total}, انتظار=${pending}, مرفوض=${rejected}, تجديد=${renewal}`);
        }

        // فلترة البيانات
        function filterData(filter) {
            updateDebug(`🔍 بدء فلترة البيانات بـ: ${filter}`);
            updateDebug(`📊 إجمالي البيانات المتاحة: ${allData.length}`);
            
            currentFilter = filter;
            
            // إزالة التحديد من جميع البطاقات
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });

            // تحديد البطاقة النشطة وفلترة البيانات
            let activeCard, title;
            
            switch(filter) {
                case 'all':
                    filteredData = allData.filter(item => {
                        return item.status === 'approved' || 
                               item.status === 'معتمد' || 
                               item.membership_number;
                    });
                    activeCard = 'totalCard';
                    title = '👥 إجمالي الأعضاء';
                    break;
                    
                case 'pending':
                    filteredData = allData.filter(item => {
                        return item.status === 'pending' || 
                               item.status === 'في الانتظار' || 
                               item.status === 'قيد المراجعة' ||
                               (!item.status && !item.membership_number);
                    });
                    activeCard = 'pendingCard';
                    title = '⏳ في انتظار المراجعة';
                    break;
                    
                case 'rejected':
                    filteredData = allData.filter(item => {
                        return item.status === 'rejected' || 
                               item.status === 'مرفوض';
                    });
                    activeCard = 'rejectedCard';
                    title = '❌ تم الرفض';
                    break;
                    
                case 'renewal':
                    filteredData = allData.filter(item => {
                        return item.status === 'renewal_requested' || 
                               item.status === 'طلب تجديد';
                    });
                    activeCard = 'renewalCard';
                    title = '🔄 طلبات التجديد';
                    break;
                    
                default:
                    filteredData = allData;
                    title = '📋 جميع السجلات';
            }

            updateDebug(`📋 البيانات المفلترة (${filter}): ${filteredData.length} سجل`);
            
            if (filteredData.length > 0) {
                updateDebug(`📄 عينة من البيانات المفلترة:`);
                filteredData.slice(0, 2).forEach((item, index) => {
                    updateDebug(`${index + 1}. ID: ${item.id}, Status: ${item.status || 'undefined'}, Name: ${item.first_name_ar || 'undefined'}`);
                });
            }

            // تحديد البطاقة النشطة
            if (activeCard) {
                const activeCardElement = document.getElementById(activeCard);
                if (activeCardElement) {
                    activeCardElement.classList.add('active');
                    updateDebug(`✅ تم تحديد البطاقة النشطة: ${activeCard}`);
                } else {
                    updateDebug(`⚠️ لم يتم العثور على البطاقة: ${activeCard}`);
                }
            }
            
            // تحديث العنوان
            const titleElement = document.getElementById('tableTitle');
            if (titleElement) {
                titleElement.textContent = title;
                updateDebug(`✅ تم تحديث العنوان: ${title}`);
            } else {
                updateDebug(`⚠️ لم يتم العثور على عنصر العنوان`);
            }
            
            // عرض البيانات
            displayData(filteredData);
        }

        // عرض البيانات في الجدول
        function displayData(data) {
            updateDebug(`📋 بدء عرض البيانات: ${data.length} سجل`);
            
            const tableBody = document.getElementById('tableBody');
            const table = document.getElementById('dataTable');
            const emptyState = document.getElementById('emptyState');

            if (!tableBody) {
                updateDebug('❌ لم يتم العثور على tableBody');
                return;
            }

            // إخفاء حالة التحميل
            showLoading(false);

            if (data.length === 0) {
                updateDebug('📭 لا توجد بيانات لعرضها - إظهار حالة فارغة');
                if (table) table.style.display = 'none';
                if (emptyState) {
                    emptyState.innerHTML = `
                        <div class="empty-state-icon">📭</div>
                        <h3>لا توجد بيانات</h3>
                        <p>لم يتم العثور على أي سجلات تطابق الفلتر المحدد: ${currentFilter}</p>
                        <div style="margin-top: 15px; font-size: 14px; color: #9ca3af;">
                            <p>تأكد من وجود بيانات في النظام أو جرب فلتر آخر</p>
                        </div>
                    `;
                    emptyState.style.display = 'block';
                }
                return;
            }

            updateDebug('📊 إظهار الجدول وإخفاء حالة فارغة');
            if (table) table.style.display = 'table';
            if (emptyState) emptyState.style.display = 'none';

            // مسح محتوى الجدول
            tableBody.innerHTML = '';
            updateDebug('🗑️ تم مسح محتوى الجدول السابق');

            data.forEach((item, index) => {
                updateDebug(`📄 معالجة السجل ${index + 1}: ID=${item.id}, Status=${item.status || 'undefined'}`);
                
                const row = document.createElement('tr');
                
                // تحديد الحالة والأزرار
                let statusBadge, actionButtons;
                
                if (item.status === 'pending' || item.status === 'في الانتظار' || 
                    item.status === 'قيد المراجعة' || (!item.status && !item.membership_number)) {
                    statusBadge = '<span class="status-badge status-pending">في الانتظار</span>';
                    actionButtons = `<button onclick="viewApplication('${item.id}')" class="btn btn-view btn-sm">عرض</button>`;
                } else if (item.status === 'approved' || item.status === 'معتمد' || item.membership_number) {
                    statusBadge = '<span class="status-badge status-approved">معتمد</span>';
                    actionButtons = `<button onclick="viewMember('${item.id}')" class="btn btn-view btn-sm">عرض</button>`;
                } else if (item.status === 'rejected' || item.status === 'مرفوض') {
                    statusBadge = '<span class="status-badge status-rejected">مرفوض</span>';
                    actionButtons = `<button onclick="viewApplication('${item.id}')" class="btn btn-view btn-sm">عرض</button>`;
                } else if (item.status === 'renewal_requested' || item.status === 'طلب تجديد') {
                    statusBadge = '<span class="status-badge status-renewal">طلب تجديد</span>';
                    actionButtons = `
                        <button onclick="processRenewal('${item.id}')" class="btn btn-approve btn-sm">تجديد</button>
                        <button onclick="viewMember('${item.id}')" class="btn btn-view btn-sm">عرض</button>
                    `;
                } else {
                    statusBadge = '<span class="status-badge">غير محدد</span>';
                    actionButtons = `<button onclick="viewApplication('${item.id}')" class="btn btn-view btn-sm">عرض</button>`;
                }

                const fullName = `${item.first_name_ar || ''} ${item.middle_name_ar || ''} ${item.last_name_ar || ''}`.trim();
                
                // تحويل التاريخ إلى ميلادي
                let submissionDate = 'غير محدد';
                if (item.submissionDate) {
                    const date = new Date(item.submissionDate);
                    submissionDate = date.toLocaleDateString('en-GB'); // تنسيق ميلادي DD/MM/YYYY
                }
                
                // ترتيب الجدول من اليمين إلى اليسار (RTL)
                row.innerHTML = `
                    <td>${item.id ? String(item.id).substring(0, 8) : 'غير محدد'}</td>
                    <td>${item.civil_id || 'غير محدد'}</td>
                    <td>${fullName || 'غير محدد'}</td>
                    <td>${item.email || 'غير محدد'}</td>
                    <td>${item.phone || 'غير محدد'}</td>
                    <td>${item.membership_number || 'غير محدد'}</td>
                    <td>${item.membership_type || 'غير محدد'}</td>
                    <td>${submissionDate}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            ${actionButtons}
                        </div>
                    </td>
                `;

                tableBody.appendChild(row);
            });
            
            updateDebug(`✅ تم عرض ${data.length} سجل في الجدول بنجاح`);
        }

        // البحث في البيانات
        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const searchType = document.getElementById('searchType').value;

            if (!searchTerm) {
                filterData(currentFilter);
                return;
            }

            let searchResults = filteredData.filter(item => {
                switch(searchType) {
                    case 'name':
                        const fullName = `${item.first_name_ar || ''} ${item.middle_name_ar || ''} ${item.last_name_ar || ''}`.toLowerCase();
                        return fullName.includes(searchTerm);
                    case 'civil_id':
                        return (item.civil_id || '').toLowerCase().includes(searchTerm);
                    case 'membership_number':
                        return (item.membership_number || '').toLowerCase().includes(searchTerm);
                    case 'email':
                        return (item.email || '').toLowerCase().includes(searchTerm);
                    case 'all':
                    default:
                        const fullNameAll = `${item.first_name_ar || ''} ${item.middle_name_ar || ''} ${item.last_name_ar || ''}`.toLowerCase();
                        return fullNameAll.includes(searchTerm) ||
                               (item.civil_id || '').toLowerCase().includes(searchTerm) ||
                               (item.membership_number || '').toLowerCase().includes(searchTerm) ||
                               (item.email || '').toLowerCase().includes(searchTerm);
                }
            });

            displayData(searchResults);
        }

        // مسح البحث
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchType').value = 'all';
            filterData(currentFilter);
        }

        // تحديث البيانات
        function refreshData() {
            loadData();
        }

        // عرض/إخفاء مؤشر التحميل
        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            const table = document.getElementById('dataTable');
            const emptyState = document.getElementById('emptyState');

            if (show) {
                loading.style.display = 'block';
                table.style.display = 'none';
                emptyState.style.display = 'none';
            } else {
                loading.style.display = 'none';
            }
        }

        // عرض طلب العضوية
        function viewApplication(id) {
            window.location.href = `view-request.html?id=${id}`;
        }

        // عرض ملف العضو
        function viewMember(id) {
            window.location.href = `member-profile.html?id=${id}`;
        }

        // معالجة طلب التجديد
        async function processRenewal(id) {
            if (!confirm('هل تريد الموافقة على طلب التجديد؟')) {
                return;
            }

            try {
                const member = allData.find(item => item.id === id);
                if (!member) {
                    alert('لم يتم العثور على العضو');
                    return;
                }

                // تحديث تاريخ الانتهاء (إضافة سنة)
                const currentExpiry = new Date(member.expiry_date);
                const newExpiry = new Date(currentExpiry);
                newExpiry.setFullYear(newExpiry.getFullYear() + 1);

                const updatedData = {
                    ...member,
                    status: 'approved',
                    expiry_date: newExpiry.toISOString().split('T')[0],
                    renewal_date: new Date().toISOString().split('T')[0]
                };

                // تحديث في Firebase
                await db.collection('membershipApplications').doc(id).update(updatedData);

                // تحديث في التخزين المحلي
                const localData = JSON.parse(localStorage.getItem('membershipApplications') || '[]');
                const index = localData.findIndex(item => item.id === id);
                if (index !== -1) {
                    localData[index] = updatedData;
                    localStorage.setItem('membershipApplications', JSON.stringify(localData));
                }

                alert('تم تجديد العضوية بنجاح');
                loadData();

            } catch (error) {
                console.error('خطأ في تجديد العضوية:', error);
                alert('حدث خطأ أثناء تجديد العضوية');
            }
        }

        // تصدير البيانات
        function exportData() {
            exportToCSV(allData, 'جميع_البيانات');
        }

        // تصدير العرض الحالي
        function exportCurrentView() {
            const currentData = document.getElementById('tableBody').children.length > 0 ? filteredData : [];
            const fileName = document.getElementById('tableTitle').textContent.replace(/[^\w\s]/gi, '');
            exportToCSV(currentData, fileName);
        }

        // تصدير إلى CSV
        function exportToCSV(data, filename) {
            if (data.length === 0) {
                alert('لا توجد بيانات للتصدير');
                return;
            }

            const headers = [
                'رقم الطلب',
                'الاسم الكامل',
                'الرقم المدني',
                'البريد الإلكتروني',
                'الهاتف',
                'رقم العضوية',
                'نوع العضوية',
                'الحالة',
                'تاريخ التقديم',
                'تاريخ التفعيل',
                'تاريخ الانتهاء',
                'الجنسية',
                'المؤهل العلمي',
                'التخصص',
                'جهة العمل',
                'المنطقة',
                'رقم الباركود',
                'ملاحظات الموافقة',
                'أسباب الرفض'
            ];

            const csvContent = [
                headers.join(','),
                ...data.map(item => {
                    const fullName = `${item.first_name_ar || ''} ${item.middle_name_ar || ''} ${item.last_name_ar || ''}`.trim();
                    const submissionDate = item.submissionDate ? new Date(item.submissionDate).toLocaleDateString('en-GB') : '';
                    const activationDate = item.activation_date || '';
                    const expiryDate = item.expiry_date || '';
                    const statusText = getStatusText(item.status);
                    
                    // إنشاء رقم باركود للأعضاء المعتمدين
                    let barcodeNumber = '';
                    if (item.status === 'approved' && item.membership_number) {
                        barcodeNumber = `KAML${item.membership_number}${new Date().getFullYear()}`;
                    }
                    
                    return [
                        item.id || '',
                        `"${fullName}"`,
                        item.civil_id || '',
                        item.email || '',
                        item.phone || '',
                        item.membership_number || '',
                        item.membership_type || '',
                        `"${statusText}"`,
                        submissionDate,
                        activationDate,
                        expiryDate,
                        `"${item.nationality || ''}"`,
                        `"${item.qualification || ''}"`,
                        `"${item.specialization || ''}"`,
                        `"${item.workplace || ''}"`,
                        `"${item.region || ''}"`,
                        barcodeNumber,
                        `"${item.approval_notes || ''}"`,
                        `"${item.rejection_reasons || ''}"`
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // إظهار رسالة نجاح
            alert(`تم تصدير ${data.length} سجل بنجاح إلى ملف CSV`);
        }
        
        // دالة مساعدة للحصول على نص الحالة
        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'في انتظار المراجعة';
                case 'approved': return 'معتمد';
                case 'rejected': return 'مرفوض';
                case 'renewal_requested': return 'طلب تجديد';
                default: return 'غير محدد';
            }
        }

        // البحث بالضغط على Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });
    </script>
</body>
</html>

