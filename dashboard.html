<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-title {
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 16px;
        }

        .section {
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .search-bar {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .action-btn.view {
            background: #17a2b8;
            color: white;
        }

        .action-btn.edit {
            background: #28a745;
            color: white;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state img {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .add-member-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .add-member-btn:hover {
            background: #218838;
        }

        .refresh-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #138496;
        }

        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                justify-content: center;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</h1>
            <div class="user-info">
                <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <div class="user-avatar">A</div>
                <span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ admin</span>
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalMembers">0</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingApplications">0</div>
                <div class="stat-label">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="approvedApplications">0</div>
                <div class="stat-label">ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡Ø§</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rejectedApplications">0</div>
                <div class="stat-label">ØªÙ… Ø§Ù„Ø±ÙØ¶</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="renewalRequests">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯</div>
            </div>
        </div>

        <!-- Renewal Requests Section -->
        <div class="section">
            <div class="section-header">
                ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯
            </div>
            <div class="section-content">
                <div class="tabs">
                    <div class="tab active" onclick="filterRenewalRequests('all')">Ø§Ù„ÙƒÙ„</div>
                    <div class="tab" onclick="filterRenewalRequests('pending')">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                    <div class="tab" onclick="filterRenewalRequests('approved')">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</div>
                    <div class="tab" onclick="filterRenewalRequests('rejected')">Ù…Ø±ÙÙˆØ¶Ø©</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="renewalRequestsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="renewalRequestsEmptyState" class="empty-state" style="display: none;">
                    ğŸ“‹<br>
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ¬Ø¯ÙŠØ¯<br>
                    Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‡Ù†Ø§ Ø¹Ù†Ø¯ ØªÙˆÙØ±Ù‡Ø§
                </div>
            </div>
        </div>

        <!-- Members Management Section -->
        <div class="section">
            <div class="section-header">
                ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
            </div>
            <div class="section-content">
                <div class="tabs">
                    <div class="tab" onclick="exportData()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                    <div class="tab active" onclick="window.location.href='admin-add-member.html'">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ù‚Ø¯ÙŠÙ…</div>
                </div>
                
                <input type="text" class="search-bar" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡..." onkeyup="searchMembers(this.value)">
                
                <div class="tabs">
                    <div class="tab active" onclick="filterMembers('all')">Ø§Ù„ÙƒÙ„</div>
                    <div class="tab" onclick="filterMembers('active')">Ù†Ø´Ø·</div>
                    <div class="tab" onclick="filterMembers('affiliated')">Ø¹Ø¶Ùˆ Ù…Ù†ØªØ³Ø¨</div>
                    <div class="tab" onclick="filterMembers('non-affiliated')">Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…Ù†ØªØ³Ø¨</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="membersEmptyState" class="empty-state" style="display: none;">
                    ğŸ‘¥<br>
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡<br>
                    Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù‡Ù†Ø§ Ø¹Ù†Ø¯ ØªÙˆÙØ±Ù‡Ù…
                </div>
            </div>
        </div>

        <!-- Applications Section -->
        <div class="section">
            <div class="section-header">
                ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
            </div>
            <div class="section-content">
                <div class="tabs">
                    <div class="tab active" onclick="filterApplications('all')">Ø§Ù„ÙƒÙ„</div>
                    <div class="tab" onclick="filterApplications('pending')">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                    <div class="tab" onclick="filterApplications('approved')">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</div>
                    <div class="tab" onclick="filterApplications('rejected')">Ù…Ø±ÙÙˆØ¶Ø©</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="applicationsEmptyState" class="empty-state" style="display: none;">
                    ğŸ“‹<br>
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª<br>
                    Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‡Ù†Ø§ Ø¹Ù†Ø¯ ØªÙˆÙØ±Ù‡Ø§
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjGGNvJKvBXQBYWV5R7Ck8yF2QvJKvBXQ",
            authDomain: "kaml-membership-system.firebaseapp.com",
            projectId: "kaml-membership-system",
            storageBucket: "kaml-membership-system.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789012345"
        };

        // Initialize Firebase
        let db;
        let isFirebaseConnected = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseConnected = true;
            console.log('âœ… Firebase connected successfully');
        } catch (error) {
            console.error('âŒ Firebase connection failed:', error);
            isFirebaseConnected = false;
        }

        // Firebase Data Manager
        class FirebaseDataManager {
            constructor() {
                this.isOnline = isFirebaseConnected;
                console.log('Firebase Manager initialized. Online:', this.isOnline);
            }

            async saveData(collection, data) {
                if (!this.isOnline) {
                    console.log('Firebase offline - saving to localStorage only');
                    this.saveToLocalStorage(collection, data);
                    return;
                }

                try {
                    const docRef = await db.collection(collection).add(data);
                    console.log('âœ… Data saved to Firebase:', docRef.id);
                    
                    // Also save to localStorage as backup
                    this.saveToLocalStorage(collection, { ...data, id: docRef.id });
                    return docRef.id;
                } catch (error) {
                    console.error('âŒ Firebase save error:', error);
                    // Fallback to localStorage
                    this.saveToLocalStorage(collection, data);
                }
            }

            async loadData(collection) {
                console.log(`ğŸ”„ Loading data from collection: ${collection}`);
                
                if (!this.isOnline) {
                    console.log('Firebase offline - loading from localStorage');
                    return this.loadFromLocalStorage(collection);
                }

                try {
                    // Try multiple collection names
                    const possibleNames = [
                        collection,
                        'applications',
                        'membershipApplications',
                        'membership_requests',
                        'members',
                        'renewalRequests'
                    ];

                    let data = [];
                    
                    for (const name of possibleNames) {
                        try {
                            console.log(`ğŸ” Trying collection: ${name}`);
                            const snapshot = await db.collection(name).get();
                            
                            if (!snapshot.empty) {
                                console.log(`âœ… Found data in collection: ${name} (${snapshot.size} documents)`);
                                snapshot.forEach(doc => {
                                    data.push({ id: doc.id, ...doc.data() });
                                });
                                
                                // Update localStorage with Firebase data
                                localStorage.setItem(collection, JSON.stringify(data));
                                console.log(`ğŸ’¾ Updated localStorage for ${collection} with ${data.length} items`);
                                return data;
                            }
                        } catch (collectionError) {
                            console.log(`âš ï¸ Collection ${name} not accessible:`, collectionError.message);
                        }
                    }
                    
                    console.log('âš ï¸ No data found in any collection, using localStorage');
                    return this.loadFromLocalStorage(collection);
                    
                } catch (error) {
                    console.error('âŒ Firebase load error:', error);
                    return this.loadFromLocalStorage(collection);
                }
            }

            saveToLocalStorage(collection, data) {
                try {
                    const existingData = JSON.parse(localStorage.getItem(collection) || '[]');
                    const newData = Array.isArray(data) ? data : [data];
                    const updatedData = [...existingData, ...newData];
                    localStorage.setItem(collection, JSON.stringify(updatedData));
                    console.log(`ğŸ’¾ Saved to localStorage: ${collection}`);
                } catch (error) {
                    console.error('âŒ localStorage save error:', error);
                }
            }

            loadFromLocalStorage(collection) {
                try {
                    const data = JSON.parse(localStorage.getItem(collection) || '[]');
                    console.log(`ğŸ’¾ Loaded from localStorage: ${collection} (${data.length} items)`);
                    return data;
                } catch (error) {
                    console.error('âŒ localStorage load error:', error);
                    return [];
                }
            }
        }

        // Initialize Firebase Data Manager
        const firebaseManager = new FirebaseDataManager();

        // Logout function
        function logout() {
            console.log('ğŸšª Logging out...');
            
            // Clear session data
            sessionStorage.clear();
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('currentUser');
            
            // Show confirmation
            alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
            
            // Redirect to login page
            window.location.href = 'admin-login.html';
        }

        // Get status text in Arabic
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                case 'approved': return 'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡';
                case 'rejected': return 'Ù…Ø±ÙÙˆØ¶';
                case 'active': return 'Ù†Ø´Ø·';
                case 'inactive': return 'ØºÙŠØ± Ù†Ø´Ø·';
                default: return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
        }

        // Load statistics
        async function loadStats() {
            console.log('ğŸ“Š Loading statistics...');
            
            try {
                const applications = await firebaseManager.loadData('membershipApplications');
                const members = await firebaseManager.loadData('members');
                const renewals = await firebaseManager.loadData('renewalRequests');
                
                const pending = applications.filter(app => app.status === 'pending').length;
                const approved = applications.filter(app => app.status === 'approved').length;
                const rejected = applications.filter(app => app.status === 'rejected').length;
                
                document.getElementById('totalMembers').textContent = members.length;
                document.getElementById('pendingApplications').textContent = pending;
                document.getElementById('approvedApplications').textContent = approved;
                document.getElementById('rejectedApplications').textContent = rejected;
                document.getElementById('renewalRequests').textContent = renewals.length;
                
                console.log('ğŸ“Š Statistics updated:', { 
                    total: members.length, 
                    pending, 
                    approved, 
                    rejected, 
                    renewals: renewals.length 
                });
                
            } catch (error) {
                console.error('âŒ Error loading statistics:', error);
            }
        }

        // Load applications
        async function loadApplications() {
            console.log('ğŸ“‹ Loading applications...');
            
            try {
                const applications = await firebaseManager.loadData('membershipApplications');
                console.log('ğŸ“‹ Applications loaded:', applications.length);
                
                const tbody = document.getElementById('applicationsTableBody');
                const emptyState = document.getElementById('applicationsEmptyState');
                
                if (applications.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    console.log('ğŸ“‹ No applications found - showing empty state');
                    return;
                }
                
                emptyState.style.display = 'none';
                tbody.innerHTML = applications.map(app => {
                    const firstName = app.firstNameAr || app.first_name_ar || app.firstName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const middleName = app.middleNameAr || app.middle_name_ar || app.middleName || '';
                    const lastName = app.lastNameAr || app.last_name_ar || app.lastName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const email = app.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const phone = app.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const membershipType = app.membershipType || app.membership_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const submissionDate = app.submissionDate || app.submission_date || app.createdAt || new Date().toISOString();
                    const status = app.status || 'pending';
                    const appId = app.id || app.applicationId || Date.now().toString();
                    
                    console.log('ğŸ“‹ Processing application:', { firstName, lastName, email, status });
                    
                    return `
                        <tr>
                            <td>${firstName} ${middleName} ${lastName}</td>
                            <td>${email}</td>
                            <td>${phone}</td>
                            <td>${membershipType}</td>
                            <td>${new Date(submissionDate).toLocaleDateString('en-GB')}</td>
                            <td><span class="status-badge status-${status}">${getStatusText(status)}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewApplicationDetails('${appId}')">Ø¹Ø±Ø¶</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log('âœ… Applications table updated');
                
            } catch (error) {
                console.error('âŒ Error loading applications:', error);
                
                // Show error message to user
                const tbody = document.getElementById('applicationsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #dc3545; padding: 20px;">
                            âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}<br>
                            <button onclick="refreshData()" style="margin-top: 10px; padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        // Load members
        async function loadMembers() {
            console.log('ğŸ‘¥ Loading members...');
            
            try {
                const members = await firebaseManager.loadData('members');
                console.log('ğŸ‘¥ Members loaded:', members.length);
                
                const tbody = document.getElementById('membersTableBody');
                const emptyState = document.getElementById('membersEmptyState');
                
                if (members.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                tbody.innerHTML = members.map(member => {
                    const membershipNumber = member.membershipNumber || member.membership_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const name = member.name || `${member.firstName || ''} ${member.lastName || ''}`.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const email = member.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const phone = member.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const membershipType = member.membershipType || member.membership_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const joinDate = member.joinDate || member.join_date || member.createdAt || new Date().toISOString();
                    const status = member.status || 'active';
                    const memberId = member.id || member.memberId || Date.now().toString();
                    
                    return `
                        <tr>
                            <td>${membershipNumber}</td>
                            <td>${name}</td>
                            <td>${email}</td>
                            <td>${phone}</td>
                            <td>${membershipType}</td>
                            <td>${new Date(joinDate).toLocaleDateString('en-GB')}</td>
                            <td><span class="status-badge status-${status}">${getStatusText(status)}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewMemberDetails('${memberId}')">Ø¹Ø±Ø¶</button>
                                    <button class="action-btn edit" onclick="editMember('${memberId}')">ØªØ¹Ø¯ÙŠÙ„</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log('âœ… Members table updated');
                
            } catch (error) {
                console.error('âŒ Error loading members:', error);
            }
        }

        // Load renewal requests
        async function loadRenewalRequests() {
            console.log('ğŸ”„ Loading renewal requests...');
            
            try {
                const renewals = await firebaseManager.loadData('renewalRequests');
                console.log('ğŸ”„ Renewal requests loaded:', renewals.length);
                
                const tbody = document.getElementById('renewalRequestsTableBody');
                const emptyState = document.getElementById('renewalRequestsEmptyState');
                
                if (renewals.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                tbody.innerHTML = renewals.map(renewal => {
                    const requestId = renewal.id || renewal.requestId || Date.now().toString();
                    const memberName = renewal.memberName || renewal.member_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const membershipNumber = renewal.membershipNumber || renewal.membership_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const requestDate = renewal.requestDate || renewal.request_date || new Date().toISOString();
                    const currentExpiry = renewal.currentExpiry || renewal.current_expiry || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const status = renewal.status || 'pending';
                    
                    return `
                        <tr>
                            <td>${requestId}</td>
                            <td>${memberName}</td>
                            <td>${membershipNumber}</td>
                            <td>${new Date(requestDate).toLocaleDateString('en-GB')}</td>
                            <td>${new Date(currentExpiry).toLocaleDateString('en-GB')}</td>
                            <td><span class="status-badge status-${status}">${getStatusText(status)}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewRenewalDetails('${requestId}')">Ø¹Ø±Ø¶</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log('âœ… Renewal requests table updated');
                
            } catch (error) {
                console.error('âŒ Error loading renewal requests:', error);
            }
        }

        // Refresh data function
        async function refreshData() {
            console.log('ğŸ”„ Manual refresh triggered...');
            
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
            refreshBtn.disabled = true;
            
            try {
                // Force reload from Firebase
                if (firebaseManager.isOnline) {
                    console.log('ğŸ”„ Refreshing from Firebase...');
                    await firebaseManager.loadData('membershipApplications');
                    await firebaseManager.loadData('members');
                    await firebaseManager.loadData('renewalRequests');
                }
                
                // Reload all sections
                await loadStats();
                await loadApplications();
                await loadMembers();
                await loadRenewalRequests();
                
                console.log('âœ… Refresh completed successfully');
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('âŒ Refresh error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message);
            }
            
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        }

        // View application details
        function viewApplicationDetails(applicationId) {
            console.log('ğŸ‘ï¸ Viewing application:', applicationId);
            window.open(`review-application.html?id=${applicationId}`, '_blank');
        }

        // View member details
        function viewMemberDetails(memberId) {
            console.log('ğŸ‘ï¸ Viewing member:', memberId);
            window.open(`member-profile.html?id=${memberId}`, '_blank');
        }

        // Edit member
        function editMember(memberId) {
            console.log('âœï¸ Editing member:', memberId);
            window.open(`edit-member.html?id=${memberId}`, '_blank');
        }

        // View renewal details
        function viewRenewalDetails(renewalId) {
            console.log('ğŸ‘ï¸ Viewing renewal:', renewalId);
            // Implement renewal details view
            alert('Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: ' + renewalId);
        }

        // Filter functions
        function filterApplications(filter) {
            console.log('ğŸ” Filtering applications:', filter);
            // Update active tab
            document.querySelectorAll('.section:last-child .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Implement filtering logic
            loadApplications();
        }

        function filterMembers(filter) {
            console.log('ğŸ” Filtering members:', filter);
            // Update active tab
            document.querySelectorAll('.section:nth-child(4) .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Implement filtering logic
            loadMembers();
        }

        function filterRenewalRequests(filter) {
            console.log('ğŸ” Filtering renewal requests:', filter);
            // Update active tab
            document.querySelectorAll('.section:nth-child(3) .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Implement filtering logic
            loadRenewalRequests();
        }

        // Search function
        function searchMembers(query) {
            console.log('ğŸ” Searching members:', query);
            // Implement search logic
        }

        // Export data function
        function exportData() {
            console.log('ğŸ“¤ Exporting data...');
            alert('ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ Dashboard loading started...');
            
            // Check if user is logged in
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn') || localStorage.getItem('adminLoggedIn');
            if (!isLoggedIn) {
                console.log('âŒ User not logged in, redirecting...');
                window.location.href = 'admin-login.html';
                return;
            }
            
            try {
                console.log('ğŸ“Š Loading dashboard data...');
                
                // Load all data
                await loadStats();
                await loadApplications();
                await loadMembers();
                await loadRenewalRequests();
                
                console.log('âœ… Dashboard loaded successfully');
                
            } catch (error) {
                console.error('âŒ Error loading dashboard:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: ' + error.message);
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
        });

        console.log('ğŸ“‹ Dashboard script loaded successfully');
    </script>
</body>
</html>

